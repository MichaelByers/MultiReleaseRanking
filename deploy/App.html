<!DOCTYPE html>
<html>
<head>
    <title>MultiReleaseRanking</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",margin:15,cls:"release-ranking",launch:function(){var dataContext=this.context.getDataContext();dataContext.projectScopeDown=!1,this.add({xtype:"component",cls:"title",html:"Multi Release Ranking",padding:"0, 0, 10, 0"},{xtype:"rallymultiobjectpicker",modelType:"release",fieldLable:"Select a release",listeners:{blur:this._runQuery,scope:this},storeConfig:{filters:[{property:"State",operator:"!=",value:"Accepted"}],context:dataContext}})},_runQuery:function(picker){var myContext=this.context.getDataContext();myContext.projectScopeDown=!0;var filter=null,pRelease=picker.getValue();if(null!=pRelease&&pRelease.length>0){for(var i=0;pRelease.length>i;i++){var release=pRelease[i].data.Name,newFilter=new Rally.data.QueryFilter({property:"Release.Name",operator:"=",value:release});filter=null==filter?newFilter:filter.or(newFilter)}Ext.create("Rally.data.WsapiDataStore",{model:"UserStory",context:myContext,autoLoad:!0,filters:filter,fetch:"Name,FormattedID,ScheduleState,PlanEstimate,KanbanState,Iteration,Release,Project,Ready,Rank,Blocked",sorters:[{property:"Rank"}],listeners:{load:function(store,data){this._onStoriesLoaded(store,data,picker)},scope:this}})}},_onStoriesLoaded:function(sStore,sData,picker){var myContext=this.context.getDataContext();myContext.projectScopeDown=!0;var filter=null,pRelease=picker.getValue();if(null!=pRelease&&pRelease.length>0){for(var i=0;pRelease.length>i;i++){var release=pRelease[i].data.Name,newFilter=new Rally.data.QueryFilter({property:"Release.Name",operator:"=",value:release});filter=null==filter?newFilter:filter.or(newFilter)}Ext.create("Rally.data.WsapiDataStore",{model:"Defect",context:myContext,autoLoad:!0,filters:filter,fetch:"Name,FormattedID,ScheduleState,PlanEstimate,c_KanbanState,Iteration,Release,Project,Ready,Rank,Blocked",sorters:[{property:"Rank"}],listeners:{load:function(dStore,dData){this._onDefectsLoaded(dStore,dData,sData)},scope:this}})}},_onDefectsLoaded:function(store,dData,sData){for(var myData=sData.concat(dData),d=[],i=0;myData.length>i;i++)d[i]=myData[i].data;this._sortByKey(d,"Rank"),Rally.data.ModelFactory.getModel({type:"UserStory",success:function(userStoryModel){var dataStore=Ext.create("Ext.data.Store",{data:d,model:userStoryModel,autoLoad:!0});this._createGrid(dataStore)},scope:this})},_sortByKey:function(array,key){return array.sort(function(a,b){var x=a[key],y=b[key];return y>x?-1:x>y?1:0})},_createGrid:function(dataStore){this.add({xtype:"rallygrid",store:dataStore,columnCfgs:[{xtype:"rownumberer"},{text:"Manual Rank Above",xtype:"numbercolumn",width:60},{text:"Name",dataIndex:"Name"}],enableRanking:!0})}});
                

            Rally.launchApp('CustomApp', {
                name:"MultiReleaseRanking",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app .title {
	font-size: 18px;
}

    </style>
</head>
<body></body>
</html>
