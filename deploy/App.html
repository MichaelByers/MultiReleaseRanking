<!DOCTYPE html>
<html>
<head>
    <title>MultiReleaseRanking</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",margin:15,cls:"release-ranking",hideCheckbox:!0,filter:void 0,launch:function(){var dataContext=this.context.getDataContext();dataContext.projectScopeDown=!1,this.add({xtype:"component",cls:"title",html:"Multi Release Ranking",padding:"0, 0, 10, 0"},{xtype:"rallymultiobjectpicker",modelType:"release",itemId:"rankingreleasepicker",fieldLabel:"Select releases: ",listeners:{blur:this._runQuery,scope:this},storeConfig:{filters:[{property:"State",operator:"!=",value:"Accepted"}],context:dataContext}},{xtype:"checkbox",mode:"single",fieldLabel:"Hide Accepted",allowDeselect:!0,id:"hideCheckbox",scope:this,checked:this.hideCheckbox,handler:this._onHideChange})},_onHideChange:function(){this.hideCheckbox=Ext.getCmp("hideCheckbox").getValue(),this._makeFilter(),this._createStoryStore()},_makeFilter:function(){var filter=null,pRelease=this.down("#rankingreleasepicker").getValue();if(null!==pRelease&&pRelease.length>0){for(var i=0;pRelease.length>i;i++){var release=pRelease[i].data.Name,newFilter=new Rally.data.QueryFilter({property:"Release.Name",operator:"=",value:release});filter=null===filter?newFilter:filter.or(newFilter)}if(this.filter=filter,1==this.hideCheckbox){var newFilter=new Rally.data.QueryFilter({property:"ScheduleState",operator:"!=",value:"Accepted"});this.filter=this.filter.and(newFilter)}}},_runQuery:function(store,data){this._makeFilter(),this._createStoreForGrid()},_createStoryStore:function(){Ext.create("Rally.data.WsapiDataStore",{model:"UserStory",autoLoad:!0,filters:this.filter,fetch:"Name,FormattedID,ScheduleState,PlanEstimate,c_KanbanState,Iteration,Release,Project,Ready,Rank,Blocked",sorters:[{property:"Rank"}],listeners:{load:function(store,data){this._onStoriesLoaded(store,data)},scope:this}})},_onStoriesLoaded:function(sStore,sData){Ext.create("Rally.data.WsapiDataStore",{model:"Defect",autoLoad:!0,filters:this.filter,fetch:"Name,FormattedID,ScheduleState,PlanEstimate,c_KanbanState,Iteration,Release,Project,Ready,Rank,Blocked",sorters:[{property:"Rank"}],listeners:{load:function(dStore,dData){this._onDefectsLoaded(dStore,dData,sData)},scope:this}})},_onDefectsLoaded:function(store,dData,sData){for(var myData=sData.concat(dData),d=[],i=0;myData.length>i;i++)d[i]=myData[i].data;this._sortByKey(d,"Rank");var grid=this.down("rallygrid");grid&&(grid.getStore().loadData(d),grid.setLoading(!1))},_sortByKey:function(array,key){return array.sort(function(a,b){var x=a[key],y=b[key];return y>x?-1:x>y?1:0})},_createStoreForGrid:function(){this.previousState="commit",Rally.data.ModelFactory.getModel({type:"UserStory",success:function(userStoryModel){var dataStore=Ext.create("Rally.data.WsapiDataStore",{model:userStoryModel,filters:[{property:"Name",value:"DoesNotExist"}],sorters:[{property:"Rank"}],listeners:{beforeload:function(store){return"DoesNotExist"===store.filters.items[0].value?(this._createStoryStore(),!1):void 0},update:function(store,record,operation,modifiedFieldNames){operation===this.previousState&&this._createStoryStore(),this.previousState=operation},create:this._createStoryStore,scope:this}});this._createGrid(dataStore)},scope:this})},_createGrid:function(dataStore){this._overrideProxyWriter(dataStore);var grid=this.down("rallygrid");grid&&grid.destroy(),this.add({xtype:"rallygrid",store:dataStore,disableColumnMenus:!1,autoAddAllModelFieldsAsColumns:!0,sortableColumns:!1,editingConfig:{listeners:{edit:this._manualRankIfManualRankColumn,beforeedit:function(editor,e){},scope:this}},columnCfgs:[{xtype:"rownumberer"},{text:"Manual Rank Above",xtype:"numbercolumn",itemId:"manualRank",width:60,editor:{xtype:"numberfield",minValue:1}},"FormattedID","Name","c_KanbanState",{text:"Release",xtype:"templatecolumn",tpl:"{Release._refObjectName}",editor:{xtype:"rallycombobox",itemId:"releasebox",storeConfig:{model:"Release",autoLoad:!0}}}],viewConfig:{stripeRows:!1},enableRanking:!0});var grid=this.down("rallygrid");grid.getView().getRowClass=function(record,index,param,store){return record.get("Ready")?"green-back":record.get("Blocked")?"red-back":index>=5?"gray-back":void 0},grid.setLoading(!0),grid.getStore().load()},_manualRankIfManualRankColumn:function(editor,e){if("releasebox"===e.column.getEditor().getItemId()&&e.record.set("Release",e.value),"manualRank"===e.column.getItemId()&&null!==e.value){var recordToRank=e.record,store=this.down("rallygrid").getStore(),relativeRecordIdx=e.value-1,pos="before";e.value>=store.getCount()&&(relativeRecordIdx=store.getCount()-1,pos="after");var relativeRecord=this.down("rallygrid").getStore().getAt(relativeRecordIdx);Rally.data.Ranker.rankRelative({recordToRank:recordToRank,relativeRecord:relativeRecord,position:pos})}},_overrideProxyWriter:function(dataStore){Ext.override(dataStore.getProxy().writer,{writeRecords:function(request,data){request.url=request.url.replace("hierarchicalrequirement",request.records[0].get("_type")),request.url=request.url.replace("HierarchicalRequirement",request.records[0].get("_type"));var root=request.records[0].get("_type");return this.allowSingle&&1==data.length&&(data=data[0]),this.encode?root?request.params[root]=Ext.encode(data):Ext.Error.raise("Must specify a root when using encode"):(request.jsonData=request.jsonData||{},root?request.jsonData[root]=data:request.jsonData=data),request}})}});
                
                

            Rally.launchApp('CustomApp', {
                name:"MultiReleaseRanking",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app .title {
	font-size: 18px;
}

.green-back {
	color: #3cb371 !important;
}

.red-back {
    color: red !important;
}

.yellow-back {
	color: yellow;
}

.gray-back {
	color: gray;
}

.error-row .x-grid-cell {
    background-color: #FFF000 !important;font-weight: bold; border: 0;
}


    </style>
</head>
<body></body>
</html>
